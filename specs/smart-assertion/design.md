# æ™ºèƒ½æ–­è¨€ç”Ÿæˆ æŠ€æœ¯æ–¹æ¡ˆè®¾è®¡æ–‡æ¡£

## 1. é¡¹ç›®èƒŒæ™¯ä¸ç›®æ ‡

æµ‹è¯•æ–­è¨€æ˜¯ä¿è¯æµ‹è¯•æœ‰æ•ˆæ€§çš„å…³é”®ï¼Œä½†æ‰‹åŠ¨ç¼–å†™æ–­è¨€è´¹æ—¶è´¹åŠ›ï¼Œä¸”å®¹æ˜“é—æ¼å…³é”®éªŒè¯ç‚¹ã€‚æœ¬æ¨¡å—é€šè¿‡ AI åˆ†ææ“ä½œä¸Šä¸‹æ–‡ï¼Œè‡ªåŠ¨æ¨èåˆé€‚çš„æ–­è¨€ï¼Œç›®æ ‡æ˜¯å°†æ–­è¨€è¦†ç›–ç‡æå‡ 50%ï¼ŒåŒæ—¶å‡å°‘ 70% çš„æ–­è¨€ç¼–å†™æ—¶é—´ã€‚

## 2. ç³»ç»Ÿæ¶æ„è®¾è®¡

### 2.1 æ€»ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Smart Assertion Module                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚   Context    â”‚  â”‚  Assertion   â”‚  â”‚   Template   â”‚       â”‚
â”‚  â”‚   Analyzer   â”‚  â”‚  Generator   â”‚  â”‚   Manager    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚         â”‚                 â”‚                 â”‚               â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                      â”‚                                       â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚              â”‚  Assertion    â”‚                              â”‚
â”‚              â”‚  Validator    â”‚                              â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â–¼            â–¼            â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Midscene â”‚  â”‚ Executionâ”‚  â”‚   YAML   â”‚
   â”‚   Core   â”‚  â”‚  Engine  â”‚  â”‚ Generatorâ”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æŠ€æœ¯æ ˆé€‰å‹

* **ä¸Šä¸‹æ–‡åˆ†æ**: Midscene AI Vision API
* **æ¨¡æ¿å­˜å‚¨**: IndexedDB
* **è§„åˆ™å¼•æ“**: è‡ªå®šä¹‰ DSL è§£æå™¨
* **UI ç»„ä»¶**: React + Framer Motion (åŠ¨ç”»)

---

## 3. æ ¸å¿ƒæ¨¡å—è®¾è®¡

### 3.1 ä¸Šä¸‹æ–‡åˆ†æå™¨ (Context Analyzer)

#### 3.1.1 æ•°æ®ç»“æ„

```typescript
interface ActionContext {
  // æ“ä½œä¿¡æ¯
  action: {
    type: 'click' | 'input' | 'select' | 'scroll' | 'navigate';
    target: ElementInfo;
    value?: string;              // è¾“å…¥å€¼
    timestamp: number;
  };

  // é¡µé¢çŠ¶æ€
  pageState: {
    beforeScreenshot: Uint8Array;
    afterScreenshot: Uint8Array;
    beforeUrl: string;
    afterUrl: string;
    visibleChanges: VisualChange[];
  };

  // è¯­ä¹‰ä¿¡æ¯
  semantic: {
    actionIntent: string;        // AI æ¨æ–­çš„æ“ä½œæ„å›¾
    targetSemantics: string;     // ç›®æ ‡å…ƒç´ è¯­ä¹‰
    expectedOutcome: string;     // é¢„æœŸç»“æœ
  };
}

interface VisualChange {
  type: 'appeared' | 'disappeared' | 'modified';
  region: BoundingBox;
  description: string;
  confidence: number;
}

interface ElementInfo {
  text: string;
  tagName: string;
  attributes: Record<string, string>;
  boundingBox: BoundingBox;
}
```

#### 3.1.2 åˆ†ææµç¨‹

```typescript
class ContextAnalyzer {
  async analyze(context: ActionContext): Promise<AnalysisResult> {
    // 1. è¯†åˆ«æ“ä½œæ„å›¾
    const intent = await this.inferIntent(context.action);

    // 2. æ£€æµ‹é¡µé¢å˜åŒ–
    const changes = await this.detectChanges(
      context.pageState.beforeScreenshot,
      context.pageState.afterScreenshot
    );

    // 3. åˆ¤æ–­æ˜¯å¦éœ€è¦æ–­è¨€
    const needsAssertion = this.shouldAssert(intent, changes);

    // 4. ç¡®å®šæ–­è¨€ç±»å‹
    const assertionTypes = this.determineAssertionTypes(intent, changes);

    return {
      needsAssertion,
      assertionTypes,
      changes,
      intent,
    };
  }

  private shouldAssert(intent: string, changes: VisualChange[]): boolean {
    // é«˜ä»·å€¼æ–­è¨€æ—¶æœº
    const highValueIntents = [
      'submit_form',
      'login',
      'add_to_cart',
      'delete_item',
      'save_data',
      'navigate_to',
    ];

    return (
      highValueIntents.includes(intent) ||
      changes.some(c => c.type === 'appeared' && c.confidence > 0.8)
    );
  }
}
```

### 3.2 æ–­è¨€ç”Ÿæˆå™¨ (Assertion Generator)

#### 3.2.1 æ¨èæ•°æ®ç»“æ„

```typescript
interface AssertionRecommendation {
  id: string;
  type: AssertionType;
  description: string;           // è‡ªç„¶è¯­è¨€æè¿°
  confidence: number;            // ç½®ä¿¡åº¦ 0-100
  reason: string;                // æ¨èç†ç”±
  parameters: AssertionParams;   // æ–­è¨€å‚æ•°
  yamlOutput: string;            // YAML æ ¼å¼è¾“å‡º
  previewResult?: boolean;       // é¢„æ‰§è¡Œç»“æœ
}

type AssertionType =
  | 'element_exists'
  | 'element_visible'
  | 'text_contains'
  | 'text_equals'
  | 'attribute_equals'
  | 'state_check'
  | 'url_contains'
  | 'count_equals';

interface AssertionParams {
  target?: string;               // ç›®æ ‡æè¿°
  expectedValue?: string;        // é¢„æœŸå€¼
  attribute?: string;            // å±æ€§å
  operator?: 'equals' | 'contains' | 'matches' | 'gt' | 'lt';
}
```

#### 3.2.2 ç”Ÿæˆç­–ç•¥

```typescript
class AssertionGenerator {
  private strategies: AssertionStrategy[] = [
    new SuccessMessageStrategy(),
    new NavigationStrategy(),
    new StateChangeStrategy(),
    new DataValidationStrategy(),
    new ErrorPreventionStrategy(),
  ];

  async generate(
    context: ActionContext,
    analysis: AnalysisResult
  ): Promise<AssertionRecommendation[]> {
    const recommendations: AssertionRecommendation[] = [];

    for (const strategy of this.strategies) {
      if (strategy.applies(context, analysis)) {
        const assertions = await strategy.generate(context, analysis);
        recommendations.push(...assertions);
      }
    }

    // æŒ‰ç½®ä¿¡åº¦æ’åºï¼Œå»é‡ï¼Œé™åˆ¶æ•°é‡
    return this.deduplicate(recommendations)
      .sort((a, b) => b.confidence - a.confidence)
      .slice(0, 5);
  }
}
```

#### 3.2.3 å†…ç½®ç”Ÿæˆç­–ç•¥

```typescript
// ç­–ç•¥ 1: æˆåŠŸæç¤ºæ£€æµ‹
class SuccessMessageStrategy implements AssertionStrategy {
  applies(context: ActionContext, analysis: AnalysisResult): boolean {
    return ['submit_form', 'login', 'save_data'].includes(analysis.intent);
  }

  async generate(
    context: ActionContext,
    analysis: AnalysisResult
  ): Promise<AssertionRecommendation[]> {
    const newElements = analysis.changes.filter(c => c.type === 'appeared');

    return newElements
      .filter(el => this.looksLikeSuccessMessage(el))
      .map(el => ({
        id: generateId(),
        type: 'text_contains',
        description: `éªŒè¯æˆåŠŸæç¤º "${el.description}" å‡ºç°`,
        confidence: el.confidence * 100,
        reason: 'è¡¨å•æäº¤åé€šå¸¸ä¼šæ˜¾ç¤ºæˆåŠŸæç¤º',
        parameters: {
          target: el.description,
          operator: 'contains',
        },
        yamlOutput: `- assert: "é¡µé¢åŒ…å«æ–‡æœ¬ '${el.description}'"`,
      }));
  }

  private looksLikeSuccessMessage(change: VisualChange): boolean {
    const successKeywords = ['æˆåŠŸ', 'å®Œæˆ', 'success', 'å·²ä¿å­˜', 'å·²æäº¤'];
    return successKeywords.some(kw =>
      change.description.toLowerCase().includes(kw)
    );
  }
}

// ç­–ç•¥ 2: å¯¼èˆªéªŒè¯
class NavigationStrategy implements AssertionStrategy {
  applies(context: ActionContext, analysis: AnalysisResult): boolean {
    return context.pageState.beforeUrl !== context.pageState.afterUrl;
  }

  async generate(
    context: ActionContext,
    analysis: AnalysisResult
  ): Promise<AssertionRecommendation[]> {
    const newUrl = context.pageState.afterUrl;
    const urlPath = new URL(newUrl).pathname;

    return [{
      id: generateId(),
      type: 'url_contains',
      description: `éªŒè¯é¡µé¢è·³è½¬åˆ° ${urlPath}`,
      confidence: 95,
      reason: 'æ£€æµ‹åˆ°é¡µé¢å¯¼èˆªï¼Œåº”éªŒè¯ç›®æ ‡ URL',
      parameters: {
        expectedValue: urlPath,
        operator: 'contains',
      },
      yamlOutput: `- assert: "å½“å‰ URL åŒ…å« '${urlPath}'"`,
    }];
  }
}

// ç­–ç•¥ 3: çŠ¶æ€å˜åŒ–éªŒè¯
class StateChangeStrategy implements AssertionStrategy {
  applies(context: ActionContext, analysis: AnalysisResult): boolean {
    return analysis.changes.some(c => c.type === 'modified');
  }

  async generate(
    context: ActionContext,
    analysis: AnalysisResult
  ): Promise<AssertionRecommendation[]> {
    const modifications = analysis.changes.filter(c => c.type === 'modified');

    return modifications.map(mod => ({
      id: generateId(),
      type: 'state_check',
      description: `éªŒè¯ ${mod.description} çŠ¶æ€å˜åŒ–`,
      confidence: mod.confidence * 90,
      reason: 'å…ƒç´ çŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼Œåº”éªŒè¯æ–°çŠ¶æ€',
      parameters: {
        target: mod.description,
      },
      yamlOutput: `- ai: "éªŒè¯ ${mod.description} çŠ¶æ€æ­£ç¡®"`,
    }));
  }
}
```

### 3.3 æ–­è¨€éªŒè¯å™¨ (Assertion Validator)

```typescript
class AssertionValidator {
  async validate(assertion: AssertionRecommendation): Promise<ValidationResult> {
    const startTime = Date.now();

    try {
      const result = await this.executeAssertion(assertion);
      return {
        success: result,
        duration: Date.now() - startTime,
        error: null,
      };
    } catch (error) {
      return {
        success: false,
        duration: Date.now() - startTime,
        error: error.message,
      };
    }
  }

  private async executeAssertion(
    assertion: AssertionRecommendation
  ): Promise<boolean> {
    switch (assertion.type) {
      case 'text_contains':
        return this.checkTextContains(assertion.parameters);
      case 'element_exists':
        return this.checkElementExists(assertion.parameters);
      case 'url_contains':
        return this.checkUrlContains(assertion.parameters);
      // ... å…¶ä»–ç±»å‹
    }
  }
}
```

### 3.4 æ¨¡æ¿ç®¡ç†å™¨ (Template Manager)

```typescript
interface AssertionTemplate {
  id: string;
  name: string;
  description: string;
  category: 'system' | 'user' | 'team';
  trigger: {
    actionType?: string;
    elementPattern?: string;
    urlPattern?: string;
  };
  assertion: {
    type: AssertionType;
    parameters: Partial<AssertionParams>;
  };
  usageCount: number;
  createdAt: number;
}

class TemplateManager {
  async findMatchingTemplates(
    context: ActionContext
  ): Promise<AssertionTemplate[]> {
    const templates = await this.storage.getAll();

    return templates.filter(t => this.matches(t.trigger, context));
  }

  async saveAsTemplate(
    assertion: AssertionRecommendation,
    name: string
  ): Promise<AssertionTemplate> {
    const template: AssertionTemplate = {
      id: generateId(),
      name,
      description: assertion.description,
      category: 'user',
      trigger: this.inferTrigger(assertion),
      assertion: {
        type: assertion.type,
        parameters: assertion.parameters,
      },
      usageCount: 0,
      createdAt: Date.now(),
    };

    await this.storage.save(template);
    return template;
  }
}
```

---

## 4. YAML è¾“å‡ºæ ¼å¼

```yaml
# å­˜åœ¨æ€§æ–­è¨€
- assert: "å…ƒç´  'æäº¤æŒ‰é’®' å­˜åœ¨"
- assert: "é¡µé¢åŒ…å«æ–‡æœ¬ 'ç™»å½•æˆåŠŸ'"

# å†…å®¹æ–­è¨€
- ai: "éªŒè¯ç”¨æˆ·åæ˜¾ç¤ºä¸º 'admin'"
- assert: "è¾“å…¥æ¡†å€¼ç­‰äº 'test@example.com'"

# çŠ¶æ€æ–­è¨€
- ai: "éªŒè¯æäº¤æŒ‰é’®å¤„äºç¦ç”¨çŠ¶æ€"
- assert: "å¤é€‰æ¡† 'è®°ä½æˆ‘' å·²é€‰ä¸­"

# å¯¼èˆªæ–­è¨€
- assert: "å½“å‰ URL åŒ…å« '/dashboard'"
- ai: "éªŒè¯é¡µé¢æ ‡é¢˜ä¸º 'æ§åˆ¶å°'"

# æ•°æ®æ–­è¨€
- ai: "éªŒè¯è¡¨æ ¼æ˜¾ç¤º 5 æ¡æ•°æ®"
- assert: "åˆ—è¡¨æŒ‰æ—¶é—´é™åºæ’åˆ—"
```

---

## 5. UI è®¾è®¡

### 5.1 æ¨èå¡ç‰‡ç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’¡ æ–­è¨€æ¨è                               ç½®ä¿¡åº¦ 92% â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                    â”‚
â”‚  éªŒè¯ç™»å½•æˆåŠŸæç¤º "æ¬¢è¿å›æ¥ï¼Œadmin" å‡ºç°            â”‚
â”‚                                                    â”‚
â”‚  æ¨èç†ç”±: ç™»å½•æ“ä½œåæ£€æµ‹åˆ°æˆåŠŸæç¤ºæ¶ˆæ¯å‡ºç°          â”‚
â”‚                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ - assert: "é¡µé¢åŒ…å«æ–‡æœ¬ 'æ¬¢è¿å›æ¥'"           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                    â”‚
â”‚  [âœ“ éªŒè¯é€šè¿‡]                                      â”‚
â”‚                                                    â”‚
â”‚  [é‡‡ç”¨ (Enter)]  [ä¿®æ”¹]  [è·³è¿‡ (Esc)]             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 å¿«æ·é”®

| å¿«æ·é”® | æ“ä½œ |
|--------|------|
| `Enter` | é‡‡ç”¨å½“å‰æ¨è |
| `Esc` | è·³è¿‡å½“å‰æ¨è |
| `Tab` | åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªæ¨è |
| `E` | ç¼–è¾‘å½“å‰æ¨è |
| `S` | ä¿å­˜ä¸ºæ¨¡æ¿ |

---

## 6. å®æ–½è®¡åˆ’

1. **Week 1**: ä¸Šä¸‹æ–‡åˆ†æå™¨ï¼Œé¡µé¢å˜åŒ–æ£€æµ‹
2. **Week 2**: æ–­è¨€ç”Ÿæˆå™¨ï¼Œæ ¸å¿ƒç­–ç•¥å®ç°
3. **Week 3**: æ¨¡æ¿ç®¡ç†ï¼ŒYAML é›†æˆ
4. **Week 4**: UI ç»„ä»¶ï¼Œå¿«æ·é”®ï¼Œæµ‹è¯•ä¼˜åŒ–
