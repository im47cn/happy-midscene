# AI 驱动 UI 自动化测试插件 (MVP) 技术方案设计文档

## 1. 项目背景与目标

本项目旨在解决 UI 自动化测试中“脚本编写慢”与“维护成本高”的核心痛点 。通过构建一个基于 Midscene.js 的 Chrome 扩展程序，实现从 **Markdown 需求文档** 到 **Midscene YAML 测试脚本** 的自动化生成 ，并直接对接私有 GitLab 仓库进行版本管理 。

## 2. 系统架构设计

### 2.1 总体架构

系统采用 **Chrome Extension Manifest V3** 架构，完全运行在用户的本地浏览器环境中。不依赖额外的后端中间服务，确保数据的私密性和内网 GitLab 的访问畅通。

主要包含三个核心上下文环境：

1. **Side Panel (侧边栏页面):** 用户交互的主入口，运行 React/Vue 前端应用，负责业务逻辑编排。
2. **Service Worker (后台服务):** 负责持久化状态管理、跨域网络请求 (GitLab API) 代理。
3. **Content Script (注入脚本):** 负责与宿主页面 (Host Page) 的 DOM 交互，运行 Midscene.js 的探测逻辑。

### 2.2 技术栈选型

* **Extension Core:** Manifest V3, Webpack/Vite
* **UI Framework:** React + TailwindCSS (复用 Midscene 官方插件风格)
* **AI/Automation Core:** Midscene.js (Web-integration version)
* **Storage:** `chrome.storage.local` (加密存储 Token)
* **Network:** Native `fetch` (在 Service Worker 或有权限的 Context 中发起)

---

## 3. 核心模块设计

### 3.1 模块划分

系统后端逻辑（在插件内部）划分为三个主要 Service 模块：

#### A. `MarkdownParser` (需求解析服务)

负责将非结构化的 Markdown 文本转换为结构化的任务队列。

* **输入:** Markdown 文本字符串。
* **逻辑:**
* 提取 `#` 或 `##` 作为 `case_name`。
* 提取有序列表 `1.`, `2.` 作为 `steps`。
* 正则识别参数（如数字、引号内文本）作为 `potential_params`。


* **输出:** `TaskQueue` 对象。

#### B. `ExecutionEngine` (执行引擎)

这是系统的“大脑”，负责调度 Midscene.js。

* **工作流:**
* 从 `TaskQueue` 取出一个 Step。
* 将 Step 发送给 `Midscene Agent`。
* `Midscene Agent` 在 Content Script 环境中分析当前 DOM，生成 Action。
* 执行 Action (Click/Type)。
* **关键点:** 捕获执行成功的 Action 和 Selector，存入 `DraftCase` 缓冲区，用于后续生成 YAML。



#### C. `GitLabClient` (版本管理服务)

负责与私有 GitLab API 通信。

* **配置管理:** 加载/保存 `BaseURL` 和 `PrivateToken`。
* **API 封装:** `searchProjects`, `getBranches`, `createBranch`, `commitFile`。
* **鉴权:** 请求头注入 `PRIVATE-TOKEN`。

---

### 3.2 数据结构定义

#### 3.2.1 任务队列 (TaskQueue)

```typescript
interface TaskStep {
  id: string;
  originalText: string; // Markdown 原文: "1. 点击登录"
  status: 'pending' | 'running' | 'success' | 'failed';
  generatedAction?: MidsceneAction; // 执行成功后的具体指令
}

```

#### 3.2.2 待提交用例 (DraftCase -> YAML)

这是最终生成并提交给 GitLab 的文件结构，对应 PDF 流程中的“生成 YAML 格式测试用例” 。

```yaml
# Generated by AI Test Agent
target:
  url: "https://target-system.com"

cases:
  - name: "用户登录流程"
    flow:
      - ai: "点击登录按钮"
      - ai: "输入用户名 'admin'"
      - ai: "输入密码 '123456'"
      - ai: "点击提交"
      - sleep: 1000

```

---

## 4. 详细流程设计

### 4.1 脚本生成流程 (Local Mode)

此流程对应文档中的核心生成步骤 。

1. **User** 在 Side Panel 粘贴 Markdown。
2. **Parser** 解析并展示待执行步骤列表。
3. **User** 点击 "Run"。
4. **Engine** 遍历步骤：
* 调用 **Midscene** 识别当前页面 UI。
* **Midscene** 返回操作指令（如 `tap(element)`）。
* **Engine** 执行操作，若成功，将该指令序列化并追加到 YAML 缓冲区。
* 若失败，暂停队列，等待 **User** 手动介入（框选元素或修改指令）。


5. **User** 预览生成的完整 YAML，确认无误。

### 4.2 GitLab 提交流程

此流程对应文档中的“版本管理”与“提交代码仓库” 。

1. **User** 在下拉框选择 Project (API: `/projects`).
2. **User** 选择或输入新 Branch 名 (如 `feature/test-01`).
3. **Client** 检查 Branch 是否存在：
* 若无，调用 `/repository/branches` (POST) 基于 Default Branch 创建。


4. **Client** 调用 `/repository/files/:path` (POST):
* Payload 包含 `branch`, `content` (Base64 encoded), `commit_message`.


5. **GitLab** 返回 Commit ID 和 Web Link。
6. **UI** 展示成功提示并提供跳转链接。

---

## 5. 接口设计 (GitLab API 对接)

插件将直接调用 GitLab v4 API。由于运行在内网浏览器，通过 `manifest.json` 授权跨域访问。

| 动作 | Endpoint | Method | 关键参数 |
| --- | --- | --- | --- |
| **搜索项目** | `/api/v4/projects` | GET | `search`, `membership=true`, `simple=true` |
| **获取分支** | `/api/v4/projects/:id/repository/branches` | GET | `per_page=50` |
| **创建分支** | `/api/v4/projects/:id/repository/branches` | POST | `branch` (新名), `ref` (来源分支) |
| **提交文件** | `/api/v4/projects/:id/repository/files/:path` | POST | `branch`, `content`, `commit_message` |

---

## 6. 安全设计

### 6.1 Token 存储

* **严禁** 将 Access Token 硬编码在代码中。
* 使用 `chrome.storage.local` 进行存储。该存储区域仅限于当前扩展程序访问，且不随 Chrome 账号同步到云端，确保企业 Token 不泄露。

### 6.2 权限控制 (Manifest V3)

在 `manifest.json` 中配置最小必要权限：

```json
{
  "permissions": [
    "activeTab",      // 仅允许操作当前激活的标签页
    "storage",        // 存取配置
    "scripting"       // 注入 Midscene 核心代码
  ],
  "host_permissions": [
    "<all_urls>"      // 必需，因为私有 GitLab 域名不确定，且需操作任意被测网站
  ]
}

```

---

## 7. 部署与实施计划

1. **环境准备:**
* Node.js 开发环境。
* Chrome 开发者模式。
* 一个测试用的 GitLab 仓库和账号。


2. **开发阶段:**
* **Week 1 (Core):** 完成 Markdown 解析 + Midscene 跑通“所见即所得”的执行流。
* **Week 2 (Integration):** 完成 GitLabService 开发，实现 Project/Branch 动态获取与提交。
* **Week 3 (UI/UX):** 完善侧边栏交互，增加错误处理（如 Token 无效提示、网络超时重试）。


3. **交付物:**
* Chrome 插件安装包 (.crx 或 文件夹)。
* 操作手册（如何获取 Token，如何编写标准 Markdown）。
