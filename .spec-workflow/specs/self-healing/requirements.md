# 测试用例自愈 (Self-Healing) 需求规格说明书

## 1. 引言

本功能旨在解决 UI 自动化测试中因页面元素变化导致的测试脚本频繁失败问题。通过复用 Midscene.js 的 AI 定位能力和语义指纹机制，系统能够在元素定位失败时自动尝试修复，大幅降低测试维护成本。

### 1.1 设计原则

**核心理念：复用 Midscene AI 能力**

Midscene.js 的核心价值是用自然语言定位元素。因此：
- 如果原始描述足够语义化，直接重试就是自愈
- 不需要额外的视觉相似度、文本模糊匹配等传统策略
- 完全复用已验证的 AI 定位能力

## 2. 术语定义

| 术语 | 定义 |
|------|------|
| **自愈 (Self-Healing)** | 系统在检测到元素定位失败后，自动分析并修复定位策略的能力 |
| **语义指纹 (Semantic Fingerprint)** | 由 AI 生成的元素自然语言描述，用于唯一标识元素 |
| **置信度 (Confidence Score)** | 系统对修复结果正确性的评估分数 (0-100) |
| **Normal 模式** | 使用语义描述直接调用 AI 定位 |
| **DeepThink 模式** | 先定位搜索区域，再在子区域内精确定位 |

---

## 3. 功能需求 (Functional Requirements)

### 3.1 语义指纹采集 (Fingerprint Collection)

* **当** 测试步骤首次成功执行时，**系统** 必须 自动采集目标元素的语义指纹：
  - 调用 `describeElementAtPoint` 生成自然语言描述
  - 验证描述可反向定位到同一元素
  - 存储描述文本及辅助定位信息

* **当** 语义描述验证失败时，**系统** 应 最多重试 3 次，若仍失败则使用原始测试描述作为降级方案。

* **系统** 必须 为每个测试步骤维护唯一的指纹记录，关联 stepId。

### 3.2 失败检测与触发 (Failure Detection)

* **当** Midscene.js 返回元素定位失败时，**系统** 必须 检查是否存在该步骤的历史指纹。

* **如果** 历史指纹存在，**系统** 必须 自动触发自愈流程。

* **如果** 历史指纹不存在（首次执行），**系统** 必须 直接返回失败，不尝试自愈。

### 3.3 两层修复策略 (Healing Strategies)

* **当** 自愈流程被触发时，**系统** 必须 按优先级依次尝试以下策略：

  1. **Normal 模式**: 使用历史语义描述调用 `aiLocate(description)`
  2. **DeepThink 模式**: 使用历史语义描述调用 `aiLocate(description, { deepThink: true })`

* **当** 某一策略成功定位元素时，**系统** 必须 计算置信度分数。

* **如果** 置信度 >= 80，**系统** 应 自动采用修复结果并继续执行。

* **如果** 置信度 >= 50 且 < 80，**系统** 应 暂停执行，向用户展示修复建议供确认。

* **如果** 置信度 < 50，**系统** 必须 标记为修复失败，等待人工介入。

### 3.4 置信度计算 (Confidence Calculation)

* **系统** 必须 基于以下因素计算置信度：
  - **距离评分 (40%)**：新旧定位中心点的像素距离
  - **尺寸评分 (30%)**：新旧元素边界框的尺寸比例
  - **策略评分 (30%)**：Normal 模式满分，DeepThink 模式扣 10 分

### 3.5 修复结果管理 (Healing Result Management)

* **当** 修复成功且用户确认后，**系统** 必须 更新语义指纹库：
  - 更新 `lastKnownRect` 和 `lastKnownCenter`
  - 递增 `healingCount`
  - 更新 `updatedAt` 时间戳

* **系统** 必须 保留修复历史记录，包括：
  - 原始定位描述
  - 失败原因
  - 采用的修复策略
  - 置信度分数
  - 用户确认状态

### 3.6 自愈统计 (Statistics)

* **系统** 必须 提供以下统计指标：
  - 自愈成功率（按时间、用例、步骤）
  - Normal vs DeepThink 策略使用比例
  - 高频自愈元素排行（`healingCount` 最高的元素）
  - 平均自愈耗时

### 3.7 配置管理 (Configuration)

* **系统** 必须 提供以下可配置项：

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| `enabled` | `true` | 是否启用自愈功能 |
| `autoAcceptThreshold` | `80` | 自动采用修复结果的置信度阈值 |
| `enableDeepThink` | `true` | 是否启用 DeepThink 模式 |
| `fingerprintRetentionDays` | `90` | 指纹保留天数 |

---

## 4. 非功能需求 (Non-Functional Requirements)

### 4.1 性能 (Performance)

* **系统** 必须 确保单次自愈尝试耗时不超过 10 秒。
* Normal 模式应在 3 秒内完成；DeepThink 模式应在 8 秒内完成。

### 4.2 准确性 (Accuracy)

* **系统** 的自愈成功率目标应达到 80% 以上（对于非破坏性 UI 变更）。
* **系统** 必须 避免错误修复导致的"静默失败"，宁可暂停等待确认。

### 4.3 存储 (Storage)

* 单个语义指纹数据应控制在 500 bytes 以内。
* 单个测试项目的指纹数据总量不应超过 10MB。
* **系统** 应 自动清理超过保留期限的指纹数据。

### 4.4 兼容性 (Compatibility)

* **系统** 必须 支持 Chrome Extension 环境（IndexedDB 存储）。
* **系统** 应 支持 CLI/Node.js 环境（文件系统存储）。

---

## 5. 限制与假设 (Constraints & Assumptions)

### 5.1 假设

* 页面 UI 变化是渐进式的，不会在一次更新中完全重构
* Midscene AI 模型的定位能力稳定可靠
* 语义描述能够在 UI 变化后仍然匹配到正确元素

### 5.2 限制

* 对于完全重新设计的页面，自愈功能可能无法生效
* 首次执行的用例无法自愈（无历史指纹）
* 完全依赖 AI 定位，无传统策略降级

---

## 6. 验收标准 (Acceptance Criteria)

| 指标 | 目标 |
|------|------|
| 指纹采集成功率 | > 95% |
| 自愈成功率（UI 小幅变化） | > 80% |
| 单次自愈耗时 | < 10s |
| 误修复率（错误匹配） | < 5% |
| 存储效率（指纹/步骤） | < 500 bytes |
